version: 2
models:
- name: fct_orders
  tests:
  - dbt_utils.unique_combination_of_columns:
      combination_of_columns:
      - order_id
  - dbt_utils.expression_is_true:
      expression: total_amount >= 0 and subtotal >= 0 and tax >= 0 and delivery_fee >= 0 and discount >= 0
  columns:
  - name: order_id
    tests:
    - not_null
    description: Unique identifier for the order.
  - name: customer_id
    tests:
    - not_null
    - relationships:
        to: ref('dim_customers')
        field: customer_id
    description: Unique identifier for the customer.
  - name: delivery_address_id
    tests:
    - not_null
    - relationships:
        to: ref('dim_customer_addresses')
        field: address_id
    description: Identifier of the delivery address used for the order.
  - name: restaurant_id
    description: Unique identifier for the restaurant outlet.
  - name: currency_id
    tests:
    - relationships:
        to: ref('dim_currencies')
        field: currency_id
    description: Unique identifier for the currency.
  - name: restaurant_sk
    tests:
    - not_null
    - relationships:
        to: ref('dim_restaurants')
        field: restaurant_sk
    description: Surrogate key generated by dbt (stable identifier for the dimension row).
  - name: is_current_restaurant_details
    description: Boolean indicator flag.
  - name: order_placed_at
    description: Event timestamp (stored as timestamptz).
  - name: scheduled_delivery_at
    description: Requested/scheduled delivery timestamp.
  - name: order_date_utc
    description: UTC date derived from the corresponding timestamp.
  - name: subtotal
    description: Monetary amount (decimal) in the specified currency.
  - name: tax
    description: Monetary amount (decimal) in the specified currency.
  - name: delivery_fee
    description: Monetary amount (decimal) in the specified currency.
  - name: discount
    description: Monetary amount (decimal) in the specified currency.
  - name: total_amount
    description: Monetary amount (decimal) in the specified currency.
  - name: payment_method
    tests:
    - not_null
    - accepted_values:
        values:
        - CARD
        - DIGITAL_WALLET
        - CONTACTLESS_NFC
        - CASH
        - PAYPAL
        - BANK_TRANSFER
    description: Payment method used for the order.
  - name: payment_status
    tests:
    - not_null
    - accepted_values:
        values:
        - PENDING
        - AUTHORIZED
        - PAID
        - FAILED
        - REFUNDED
    description: Payment status of the order.
  - name: items_subtotal
    description: Reconciliation metric derived from order lines and order header.
  - name: items_total_qty
    description: Quantity/count metric.
  - name: item_lines
    description: Quantity/count metric.
  - name: distinct_menu_items
    description: Quantity/count metric.
  - name: placed_at
    description: Event timestamp (stored as timestamptz).
  - name: accepted_at
    description: Event timestamp (stored as timestamptz).
  - name: prep_start_at
    description: Event timestamp (stored as timestamptz).
  - name: ready_for_pickup_at
    description: Event timestamp (stored as timestamptz).
  - name: picked_up_at
    description: Event timestamp (stored as timestamptz).
  - name: delivered_at
    description: Event timestamp (stored as timestamptz).
  - name: canceled_at
    description: Event timestamp (stored as timestamptz).
  - name: latest_status
    description: Order lifecycle status.
  - name: latest_status_at
    description: Event timestamp (stored as timestamptz).
  - name: is_delivered
    description: Boolean indicator flag.
  - name: is_canceled
    description: Boolean indicator flag.
  - name: minutes_to_accept
    description: Elapsed time in minutes between order lifecycle milestones.
  - name: minutes_to_pickup
    description: Elapsed time in minutes between order lifecycle milestones.
  - name: minutes_to_deliver
    description: Elapsed time in minutes between order lifecycle milestones.
  - name: minutes_pickup_to_deliver
    description: Elapsed time in minutes between order lifecycle milestones.
  - name: courier_id
    description: Unique identifier for the courier.
  - name: assigned_at
    description: Delivery assignment timestamp or ETA.
  - name: pickup_eta
    description: Delivery assignment timestamp or ETA.
  - name: dropoff_eta
    description: Delivery assignment timestamp or ETA.
  - name: subtotal_minus_items
    description: Reconciliation metric derived from order lines and order header.
  - name: expected_total_from_items
    description: Reconciliation metric derived from order lines and order header.
  - name: expected_total_minus_total_amount
    description: Reconciliation metric derived from order lines and order header.
  description: Order fact table at order_id grain enriched with restaurant surrogate key and lifecycle/delivery metrics.
- name: fct_order_items
  tests:
  - dbt_utils.unique_combination_of_columns:
      combination_of_columns:
      - order_item_id
  - dbt_utils.expression_is_true:
      expression: quantity >= 1 and line_total >= 0
  columns:
  - name: order_item_id
    tests:
    - not_null
    description: Unique identifier for the order line item.
  - name: order_id
    tests:
    - not_null
    - relationships:
        to: ref('fct_orders')
        field: order_id
    description: Unique identifier for the order.
  - name: menu_item_id
    description: Unique identifier for the menu item.
  - name: menu_item_sk
    tests:
    - not_null
    - relationships:
        to: ref('dim_menu_items')
        field: menu_item_sk
    description: Surrogate key generated by dbt (stable identifier for the dimension row).
  - name: is_current_menu_item_details
    description: Boolean indicator flag.
  - name: customer_id
    description: Unique identifier for the customer.
  - name: restaurant_id
    description: Unique identifier for the restaurant outlet.
  - name: currency_id
    description: Unique identifier for the currency.
  - name: order_placed_at
    description: Event timestamp (stored as timestamptz).
  - name: order_date_utc
    description: UTC date derived from the corresponding timestamp.
  - name: quantity
    description: Quantity/count metric.
  - name: unit_price
    description: Monetary amount (decimal) in the specified currency.
  - name: line_total
    description: Monetary amount (decimal) in the specified currency.
  description: Order item fact table at order_item_id grain enriched with menu item surrogate key and order context.
- name: fct_refunds
  tests:
  - dbt_utils.unique_combination_of_columns:
      combination_of_columns:
      - refund_id
  - dbt_utils.expression_is_true:
      expression: refund_amount >= 0
  columns:
  - name: refund_id
    tests:
    - not_null
    description: Unique identifier for the refund event.
  - name: order_id
    tests:
    - not_null
    - relationships:
        to: ref('fct_orders')
        field: order_id
    description: Unique identifier for the order.
  - name: customer_id
    description: Unique identifier for the customer.
  - name: restaurant_id
    description: Unique identifier for the restaurant outlet.
  - name: restaurant_sk
    tests:
    - relationships:
        to: ref('dim_restaurants')
        field: restaurant_sk
    description: Surrogate key generated by dbt (stable identifier for the dimension row).
  - name: currency_id
    description: Unique identifier for the currency.
  - name: refund_ts
    tests:
    - not_null
    description: Event timestamp (stored as timestamptz).
  - name: refund_reason
    tests:
    - not_null
    - accepted_values:
        values:
        - LATE_DELIVERY
        - MISSING_ITEM
        - WRONG_ITEM
        - QUALITY_ISSUE
        - OTHER
    description: Categorized reason for issuing the refund.
  - name: refund_amount
    description: Monetary amount (decimal) in the specified currency.
  - name: payment_method
    description: Payment method used for the order.
  - name: payment_status
    description: Payment status of the order.
  - name: items_subtotal
    description: Reconciliation metric derived from order lines and order header.
  - name: items_total_qty
    description: Quantity/count metric.
  - name: item_lines
    description: Quantity/count metric.
  - name: distinct_menu_items
    description: Quantity/count metric.
  - name: is_refund_not_exceed_total
    description: True when the refund amount is less than or equal to the order total amount.
  description: Refund fact table at refund_id grain enriched with restaurant surrogate key and order context.
- name: fct_fx_rates
  description: FX rate fact table at fx_rate_id grain enriched with currency codes for base/quote currencies.
  columns:
  - name: fx_rate_id
    description: Unique identifier for the FX rate observation.
  - name: base_currency_id
    description: Currency identifier for the base currency in the FX pair.
  - name: base_currency_code
    description: ISO 4217 code for the base currency in the FX pair.
  - name: quote_currency_id
    description: Currency identifier for the quote currency in the FX pair.
  - name: quote_currency_code
    description: ISO 4217 code for the quote currency in the FX pair.
  - name: rate_ts
    description: Timestamp at which the FX rate applies (timestamptz).
  - name: rate
    description: FX rate value (quote currency per 1 unit of base currency).
  - name: source
    description: Source system/provider for the FX rate.
